<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telecom Customer Churn Predictor</title>
    
    <!-- Basic CSS Styles -->
    <link rel="stylesheet" href="static/style.css">
</head>
<body>

    <!-- Header -->
    <header>
        <div class="header-content">
            <h1 style="font-size: 1.875rem; font-weight: 800; color: #1F2937;">
                Telecom Churn Prediction
            </h1>
            <!-- Subtitle uses JOST -->
            <p style="font-size: 0.875rem; color: #6B7280; margin-top: 0.25rem;">Deploying the Stacking Classifier Model</p>
        </div>
    </header>

    <!-- Main Content Container -->
    <main>
        <div class="main-content">
            
            <!-- Prediction Card -->
            <div id="prediction-card" class="card">
                <!-- Card title uses OPEN SANS -->
                <h2>Customer Profile Input</h2>

                <!-- Loading Indicator (Hidden by default) -->
                <div id="loading-spinner" class="hidden loading-spinner-wrapper">
                    <div class="spinner" role="status">
                        <span class="sr-only">Loading...</span>
                    </div>
                    <p class="spinner-text">Predicting Churn...</p>
                </div>

                <!-- Prediction Form -->
                <form id="churn-form" onsubmit="event.preventDefault(); predictChurn();">

                    <!-- Grid Layout for Inputs -->
                    <div class="form-grid">
                        
                        <!-- 1. Customer Demographics Section -->
                        <div class="section-card">
                            <!-- Section header uses OPEN SANS and is now bolder -->
                            <h3>1. Profile & Status</h3>
                            <div class="space-y-4">
                                <!-- Senior Citizen (Label and Select use DOSIS) -->
                                <div class="input-field-group">
                                    <label for="SeniorCitizen">Senior Citizen</label>
                                    <select id="SeniorCitizen" name="SeniorCitizen" class="input-field" required>
                                        <option value="0">No</option>
                                        <option value="1">Yes</option>
                                    </select>
                                </div>
                                <!-- Gender -->
                                <div class="input-field-group">
                                    <label for="gender">Gender</label>
                                    <select id="gender" name="gender" class="input-field" required>
                                        <option value="Male">Male</option>
                                        <option value="Female">Female</option>
                                    </select>
                                </div>
                                <!-- Partner -->
                                <div class="input-field-group">
                                    <label for="Partner">Has Partner ?</label>
                                    <select id="Partner" name="Partner" class="input-field" required>
                                        <option value="Yes">Yes</option>
                                        <option value="No">No</option>
                                    </select>
                                </div>
                                <!-- Dependents -->
                                <div class="input-field-group">
                                    <label for="Dependents">Has Dependents ?</label>
                                    <select id="Dependents" name="Dependents" class="input-field" required>
                                        <option value="Yes">Yes</option>
                                        <option value="No">No</option>
                                    </select>
                                </div>
                                <!-- Tenure (Numerical) -->
                                <div class="input-field-group">
                                    <label for="tenure">Tenure (Months)</label>
                                    <input type="number" id="tenure" name="tenure" class="input-field" min="1" max="72" required placeholder="1 to 72">
                                </div>
                            </div>
                        </div>

                        <!-- 2. Service Details Section -->
                        <div class="section-card">
                            <!-- Section header uses OPEN SANS and is now bolder -->
                            <h3>2. Internet & Phone Services</h3>
                            <div class="space-y-4">
                                <!-- PhoneService -->
                                <div class="input-field-group">
                                    <label for="PhoneService">Phone Service</label>
                                    <select id="PhoneService" name="PhoneService" class="input-field" required>
                                        <option value="Yes">Yes</option>
                                        <option value="No">No</option>
                                    </select>
                                </div>
                                <!-- MultipleLines -->
                                <div class="input-field-group">
                                    <label for="MultipleLines">Multiple Lines</label>
                                    <select id="MultipleLines" name="MultipleLines" class="input-field" required>
                                        <option value="Yes">Yes</option>
                                        <option value="No">No</option>
                                        <option value="No phone service">No phone service</option>
                                    </select>
                                </div>
                                <!-- InternetService -->
                                <div class="input-field-group">
                                    <label for="InternetService">Internet Service Type</label>
                                    <select id="InternetService" name="InternetService" class="input-field" required>
                                        <option value="DSL">DSL</option>
                                        <option value="Fiber optic">Fiber optic</option>
                                        <option value="No">No</option>
                                    </select>
                                </div>
                                <!-- OnlineSecurity -->
                                <div class="input-field-group">
                                    <label for="OnlineSecurity">Online Security</label>
                                    <select id="OnlineSecurity" name="OnlineSecurity" class="input-field" required>
                                        <option value="Yes">Yes</option>
                                        <option value="No">No</option>
                                        <option value="No internet service">No internet service</option>
                                    </select>
                                </div>
                                <!-- OnlineBackup -->
                                <div class="input-field-group">
                                    <label for="OnlineBackup">Online Backup</label>
                                    <select id="OnlineBackup" name="OnlineBackup" class="input-field" required>
                                        <option value="Yes">Yes</option>
                                        <option value="No">No</option>
                                        <option value="No internet service">No internet service</option>
                                    </select>
                                </div>
                                <!-- DeviceProtection -->
                                <div class="input-field-group">
                                    <label for="DeviceProtection">Device Protection</label>
                                    <select id="DeviceProtection" name="DeviceProtection" class="input-field" required>
                                        <option value="Yes">Yes</option>
                                        <option value="No">No</option>
                                        <option value="No internet service">No internet service</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- 3. Billing & Support Section -->
                        <div class="section-card">
                            <!-- Section header uses OPEN SANS and is now bolder -->
                            <h3>3. Billing & Add-ons</h3>
                            <div class="space-y-4">
                                <!-- TechSupport -->
                                <div class="input-field-group">
                                    <label for="TechSupport">Tech Support</label>
                                    <select id="TechSupport" name="TechSupport" class="input-field" required>
                                        <option value="Yes">Yes</option>
                                        <option value="No">No</option>
                                        <option value="No internet service">No internet service</option>
                                    </select>
                                </div>
                                <!-- StreamingTV -->
                                <div class="input-field-group">
                                    <label for="StreamingTV">Streaming TV</label>
                                    <select id="StreamingTV" name="StreamingTV" class="input-field" required>
                                        <option value="Yes">Yes</option>
                                        <option value="No">No</option>
                                        <option value="No internet service">No internet service</option>
                                    </select>
                                </div>
                                <!-- StreamingMovies -->
                                <div class="input-field-group">
                                    <label for="StreamingMovies">Streaming Movies</label>
                                    <select id="StreamingMovies" name="StreamingMovies" class="input-field" required>
                                        <option value="Yes">Yes</option>
                                        <option value="No">No</option>
                                        <option value="No internet service">No internet service</option>
                                    </select>
                                </div>
                                <!-- Contract -->
                                <div class="input-field-group">
                                    <label for="Contract">Contract Type</label>
                                    <select id="Contract" name="Contract" class="input-field" required>
                                        <option value="Month-to-month">Month-to-Month</option>
                                        <option value="One year">One year</option>
                                        <option value="Two year">Two year</option>
                                    </select>
                                </div>
                                <!-- PaperlessBilling -->
                                <div class="input-field-group">
                                    <label for="PaperlessBilling">Paperless Billing</label>
                                    <select id="PaperlessBilling" name="PaperlessBilling" class="input-field" required>
                                        <option value="Yes">Yes</option>
                                        <option value="No">No</option>
                                    </select>
                                </div>
                                <!-- PaymentMethod -->
                                <div class="input-field-group">
                                    <label for="PaymentMethod">Payment Method</label>
                                    <select id="PaymentMethod" name="PaymentMethod" class="input-field" required>
                                        <option value="Electronic check">Electronic check</option>
                                        <option value="Mailed check">Mailed check</option>
                                        <option value="Bank transfer (automatic)">Bank transfer (automatic)</option>
                                        <option value="Credit card (automatic)">Credit card (automatic)</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Financial Inputs (Below the main grid) -->
                    <div class="financial-inputs">
                        <!-- MonthlyCharges (Numerical) -->
                        <div class="input-field-group">
                            <label for="MonthlyCharges">Monthly Charges ($)</label>
                            <input type="number" step="0.01" id="MonthlyCharges" name="MonthlyCharges" class="input-field" min="0" required placeholder="e.g., 70.35">
                        </div>
                        <!-- TotalCharges (Numerical) -->
                        <div class="input-field-group">
                            <label for="TotalCharges">Total Charges ($)</label>
                            <input type="number" step="0.01" id="TotalCharges" name="TotalCharges" class="input-field" min="0" required placeholder="e.g., 2000.50">
                        </div>
                    </div>
                    
                    <!-- Submit Button uses SHARE TECH and is now bolder -->
                    <div style="padding-top: 1.5rem;">
                        <button type="submit" id="predict-button" class="submit-button">
                            PREDICT CUSTOMER CHURN
                        </button>
                    </div>
                </form>

                <!-- Result Display Area (Prediction Section uses JOST) -->
                <div id="result-container" class="hidden result-text-area">
                    <h3 id="result-title"></h3>
                    <p style="font-size: 1.125rem;" id="result-text"></p>
                </div>

                <!-- Error Message Area -->
                <div id="error-message" class="hidden">
                    <p class="font-bold">Prediction Error</p>
                    <p id="error-details"></p>
                </div>
            </div>

            <!-- Instructions/Disclaimer (Note uses JOST) -->
            <div class="note-disclaimer" style="margin-top: 2rem; text-align: center; color: #6B7280; font-size: 0.875rem;">
                <p>Note: This application uses a pre-trained Stacking Classifier to predict customer churn based on the provided telecom attributes.</p>
            </div>
        </div>
    </main>
    
    <!-- Footer (Uses JOST) -->
    <footer>
        <div class="header-content">
            &copy; 2025 Telecom Churn Predictor App. All rights reserved.
        </div>
    </footer>

    <!-- JavaScript Logic (Unchanged from previous version as it is basic JS) -->
    <script>
        const form = document.getElementById('churn-form');
        const resultContainer = document.getElementById('result-container');
        const resultTitle = document.getElementById('result-title');
        const resultText = document.getElementById('result-text');
        const loadingSpinner = document.getElementById('loading-spinner');
        const errorMessage = document.getElementById('error-message');
        const errorDetails = document.getElementById('error-details');
        const predictButton = document.getElementById('predict-button');

        // Function to show/hide loading state
        function setLoading(isLoading) {
            if (isLoading) {
                loadingSpinner.classList.remove('hidden');
                predictButton.disabled = true;
                // Simple text loading state for basic CSS
                predictButton.innerHTML = `<span class="spinner" style="width: 1rem; height: 1rem; border-width: 2px; margin-right: 0.5rem;"></span>Processing...`;
                resultContainer.classList.add('hidden');
                errorMessage.classList.add('hidden');
            } else {
                loadingSpinner.classList.add('hidden');
                predictButton.disabled = false;
                predictButton.innerHTML = 'PREDICT CUSTOMER CHURN';
            }
        }

        // Function to perform the API call
        async function predictChurn() {
            setLoading(true);

            // 1. Gather Input Data
            const formData = {};
            const inputElements = form.querySelectorAll('input, select');
            
            inputElements.forEach(element => {
                const value = element.value;
                // Attempt to convert numerical inputs to numbers, otherwise keep as string
                const numValue = parseFloat(value);
                formData[element.name] = isNaN(numValue) ? value : numValue;
            });

            try {
                // 2. API Call with Exponential Backoff
                const maxRetries = 3;
                let response = null;
                
                for (let i = 0; i < maxRetries; i++) {
                    try {
                        response = await fetch('/predict', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(formData)
                        });
                        if (response.ok) break; // Exit loop on success
                    } catch (e) {
                        // Log error internally but do not show to user unless all retries fail
                        console.error(`Attempt ${i + 1} failed:`, e); 
                    }
                    if (i < maxRetries - 1) {
                        const delay = Math.pow(2, i) * 1000; // 1s, 2s, 4s...
                        await new Promise(resolve => setTimeout(resolve, delay));
                    }
                }
                
                if (!response || !response.ok) {
                    throw new Error(`Failed to get a successful response after ${maxRetries} attempts.`);
                }
                
                // 3. Process Response
                const result = await response.json();

                if (result.error) {
                    // Handle API-specific errors (e.g., malformed input)
                    throw new Error(result.error || "Unknown server-side processing error.");
                }

                const prediction = result.prediction; // 0 or 1
                const modelName = result.model;

                // 4. Update UI based on prediction
                let title, bgColor, textColor;

                if (prediction === 1) {
                    title = 'High Risk of Churn';
                    text = `Action Required: This customer is predicted to churn based on the model. Model: ${modelName}.`;
                    bgColor = '#FEF2F2'; /* Red-50 */
                    textColor = '#B91C1C'; /* Red-700 */
                } else {
                    title = 'Customer is Stable';
                    text = `Status: This customer is predicted to remain with the company. Model: ${modelName}.`;
                    bgColor = '#F0FFF4'; /* Green-50 */
                    textColor = '#10B981'; /* Green-700 */
                }

                // Apply styles and content
                resultContainer.style.backgroundColor = bgColor;
                resultContainer.style.color = textColor;
                resultTitle.textContent = title;
                resultText.textContent = text;
                resultContainer.classList.remove('hidden');

            } catch (error) {
                console.error('Final prediction error:', error);
                errorDetails.textContent = error.message;
                errorMessage.classList.remove('hidden');
                resultContainer.classList.add('hidden'); // Ensure result is hidden on error
            } finally {
                setLoading(false);
            }
        }
    </script>
</body>
</html>